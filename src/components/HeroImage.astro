---
// src/components/HeroImage.astro
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

export interface Props {
    src: string;
    alt?: string;
    caption?: string;
    width?: number | string;
    height?: number | string;
    className?: string;
    srcset?: string;
}
const defaultWidth = 1200;
const defaultHeight = 630;
const { src, alt = '', caption, width = defaultWidth, height = defaultHeight, className = '', srcset = '' } = Astro.props;

// Фиксированные пропорции 1200:630
const aspectRatio = '1200 / 630';

// Генерируем адаптивные версии изображений
function getResponsiveImages(imagePath: string) {
    const basePath = imagePath.replace(/\.(webp|jpg|jpeg|png)$/i, '');
    const extension = imagePath.match(/\.(webp|jpg|jpeg|png)$/i)?.[0] || '.webp';

    // Проверяем существование адаптивных версий
    const __filename = fileURLToPath(import.meta.url);
    const projectRoot = path.resolve(path.dirname(__filename), '../..');

    const variants = [
        { suffix: '-400', width: '400w' },
        { suffix: '-800', width: '800w' },
        { suffix: '-1200', width: '1200w' }
    ];

    const srcsetItems = [];

    // Добавляем адаптивные версии, если они существуют
    for (const variant of variants) {
        const variantPath = `${basePath}${variant.suffix}${extension}`;
        const filePath = path.join(projectRoot, 'public', variantPath.replace(/^\//, ''));

        if (fs.existsSync(filePath)) {
            srcsetItems.push(`${variantPath} ${variant.width}`);
        }
    }

    // Если нет адаптивных версий, добавляем оригинальное как fallback
    if (srcsetItems.length === 0) {
        srcsetItems.push(imagePath);
    }

    return {
        src: imagePath,
        srcset: srcsetItems.join(', '),
        sizes: '(max-width: 768px) 100vw, (max-width: 1024px) 80vw, 1200px'
    };
}

let imageData;
if (srcset) {
    // Если передан готовый srcset, используем его
    imageData = {
        src: src,
        srcset: srcset,
        sizes: '100vw'
    };
} else {
    // Генерируем адаптивные изображения
    imageData = getResponsiveImages(src);
}

// Используем уменьшенное превью, если оно существует
let previewImage;
if (imageData.src) {
    previewImage = imageData.src.replace(/\/([^\/]+)$/, '/previews/$1');

    const __filename = fileURLToPath(import.meta.url);
    const projectRoot = path.resolve(path.dirname(__filename), '../..');
    const previewFilePath = path.join(projectRoot, 'public', previewImage.replace(/^\//, ''));

    if (!fs.existsSync(previewFilePath)) {
        previewImage = undefined;
    }
}

const finalImage = previewImage || imageData.src;
---

<figure class={`w-full max-w-[${width}px] mx-auto rounded-custom overflow-hidden bg-[var(--bg-muted)] ${className}`}>
    <img
        src={finalImage}
        srcset={imageData.srcset}
        sizes={imageData.sizes}
        alt={alt}
        width={width}
        height={height}
        style={`aspect-ratio: ${aspectRatio}; width: 100%; height: auto;`}
        class="block rounded-custom object-cover"
        loading="eager"
        decoding="async"
    />
    {caption && <figcaption class="mt-2 text-sm text-[var(--text-main)] opacity-80 text-center px-2">{caption}</figcaption>}
</figure>
