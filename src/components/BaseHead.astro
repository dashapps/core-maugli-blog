---
import { maugliConfig } from '../config/maugli.config';
import siteConfig from '../data/site-config';
import '../styles/global.css';
import { getFilteredCollection } from '../utils/content-loader';
// Определи тип выше:
export type ImageMimeType = 'image/jpeg' | 'image/png' | 'image/webp';

export type Props = {
    title?: string;
    description?: string;
    image?: {
        width?: string;
        height?: string;
        type?: ImageMimeType;
        src: string;
        alt?: string;
    };
    pageType?: 'website' | 'article';
    seo?: {
        title?: string;
        description?: string;
        keywords?: string[];
        image?: {
            width?: string;
            height?: string;
            type?: ImageMimeType;
            src: string;
            alt?: string;
        };
        pageType?: 'website' | 'article';
    };
};

const { seo = {}, title: baseTitle, description: baseDescription = '', image: baseImage = siteConfig.image, pageType: basePageType = 'website' } = Astro.props;

// ОДНА переменная для title, description, keywords, image, pageType
const seoTitle = seo.title || baseTitle || siteConfig.title;
const seoDescription = seo.description || baseDescription || siteConfig.description;
const seoKeywords = seo.keywords?.length ? seo.keywords.join(', ') : '';
const seoImage = seo.image || baseImage || siteConfig.image;

const resolvedImage =
    seoImage && seoImage.src
        ? {
              src: new URL(seoImage.src, Astro.site).toString(),
              alt: seoImage.alt,
              width: 'width' in seoImage ? seoImage.width : undefined,
              height: 'height' in seoImage ? seoImage.height : undefined,
              type: 'type' in seoImage ? seoImage.type : undefined
          }
        : undefined;
const pageType = seo.pageType || basePageType;
const canonicalURL = new URL(Astro.request.url, Astro.site);

/**
 * Enforce some standard canonical URL formatting across the site.
 */
function formatCanonicalURL(url: string | URL) {
    const path = url.toString();
    const hasQueryParams = path.includes('?');
    // If there are query params, make sure the URL has no trailing slash
    if (hasQueryParams) {
        return path.replace(/\/?$/, '');
    }
    // otherwise, canonical URL always has a trailing slash
    return path.replace(/\/?$/, '/');
}

let authors = [];
try {
    authors = await getFilteredCollection('authors');
} catch (e) {
    console.warn('Не удалось загрузить коллекцию авторов:', e);
}
if (authors.length === 0) {
    throw new Error('В коллекции авторов нет ни одного автора. Создайте хотя бы одного автора!');
}
let defaultAuthor = authors[0];
let defaultAuthorName = defaultAuthor.data.name;
---

<!-- High Priority Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>{seoTitle}</title>
<meta name="robots" content="index, follow" />
<meta name="generator" content={Astro.generator} />

<!-- Critical CSS Inline for Performance -->
<style>
    :root {
        --brand-color-rgb: 12, 191, 17;
        --brand-color: rgb(var(--brand-color-rgb));
        --text-main: #111c2d;
        --text-heading: #3b5174;
        --text-muted: #6b7280;
        --bg-main: #ffffff;
        --bg-muted: rgba(237, 241, 247, 0.621);
        --border-main: rgba(17, 28, 44, 0.13);
        --font-sans: 'Inter Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --font-serif: 'Geologica Variable', Georgia, 'Times New Roman', serif;
    }
    html.dark {
        --brand-color-rgb: 13, 211, 18;
        --brand-color: rgb(var(--brand-color-rgb));
        --text-main: #ffffff;
        --text-heading: rgba(202, 252, 254, 0.7);
        --text-muted: #9ca3af;
        --bg-main: #0b131e;
        --bg-muted: #131d2cde;
        --border-main: rgba(51, 66, 66, 0.6);
    }
    body {
        font-family: var(--font-sans);
        color: var(--text-main);
        background-color: var(--bg-main);
        margin: 0;
        line-height: 1.5;
    }
    * {
        box-sizing: border-box;
    }
</style>

<!-- Critical Resource Preloading for Performance -->
<link rel="preload" href="/favicon.svg" as="image" type="image/svg+xml" />
<link rel="preload" href="/footerlabel.svg" as="image" type="image/svg+xml" />
<!-- Image Optimization Hints -->
<meta name="format-detection" content="telephone=no" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta http-equiv="x-ua-compatible" content="ie=edge" />

<!-- Resource Hints for Performance -->
<link rel="dns-prefetch" href="//fonts.bunny.net" />
<link rel="preconnect" href="//fonts.bunny.net" crossorigin />

<!-- SEO -->
<meta name="description" content={seoDescription} />
<meta name="keywords" content={seoKeywords} />
<meta name="author" content={defaultAuthorName} />
<link rel="canonical" href={formatCanonicalURL(canonicalURL)} />

<!-- Low Priority Global Metadata -->
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="manifest" href="/manifest.webmanifest" />
<meta name="theme-color" content={maugliConfig.pwa?.themeColor || '#0cbf11'} />
<link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png" />
<link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png" />
<link rel="sitemap" href="/sitemap-index.xml" />
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={pageType} />
<meta property="og:url" content={formatCanonicalURL(canonicalURL)} />
<meta property="og:title" content={seoTitle} />
<meta property="og:description" content={seoDescription} />
{resolvedImage?.src && <meta property="og:image" content={resolvedImage.src} />}
{resolvedImage?.alt && <meta property="og:image:alt" content={resolvedImage.alt} />}
{typeof resolvedImage?.width !== 'undefined' && <meta property="og:image:width" content={resolvedImage.width.toString()} />}
{typeof resolvedImage?.height !== 'undefined' && <meta property="og:image:height" content={resolvedImage.height.toString()} />}
{resolvedImage?.type && <meta property="og:image:type" content={resolvedImage.type} />}

<!-- X/Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={formatCanonicalURL(canonicalURL)} />
<meta property="twitter:title" content={seoTitle} />
<meta property="twitter:description" content={seoDescription} />
{resolvedImage?.src && <meta property="twitter:image" content={resolvedImage.src} />}
{resolvedImage?.alt && <meta name="twitter:image:alt" content={resolvedImage?.alt} />}

<!-- PWA Registration -->
<script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('SW registered: ', registration);
            } catch (registrationError) {
                console.log('SW registration failed: ', registrationError);
            }
        });
    }
</script>
