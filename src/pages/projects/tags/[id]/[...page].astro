---
import type { GetStaticPathsOptions, Page } from 'astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import Breadcrumbs from '../../../../components/Breadcrumbs.astro';
import Pagination from '../../../../components/Pagination.astro';
import ProjectPreview from '../../../../components/ProjectPreview.astro';
import TagsSection from '../../../../components/TagsSection.astro';
import siteConfig from '../../../../data/site-config';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { slugify } from '../../../../utils/common-utils';
import { sortItemsByDateDesc } from '../../../../utils/data-utils';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
    const allProjects = (await getCollection('projects')).sort(sortItemsByDateDesc);
    const allTags = [...new Set(allProjects.flatMap((project) => project.data.tags || []))];

    return allTags.flatMap((tag) => {
        const filteredProjects = allProjects.filter((project) => (project.data.tags || []).includes(tag));
        return paginate(filteredProjects, {
            params: { id: slugify(tag) },
            pageSize: siteConfig.projectsPerPage || 6,
            props: { tag }
        });
    });
}

type Props = { page: Page<CollectionEntry<'projects'>>; tag: string };

const { page, tag } = Astro.props;
const projects = page.data;

// Получаем все теги для отображения в TagsSection
const allProjects = await getCollection('projects');
const allTags = [...new Set(allProjects.flatMap((project) => project.data.tags || []))];
const tagsWithCount = allTags.map((tagName) => ({
    id: slugify(tagName),
    name: tagName,
    count: allProjects.filter((project) => (project.data.tags || []).includes(tagName)).length
}));
---

<BaseLayout title={`Сервисы по тегу "${tag}"`} description={`Explore projects tagged with "${tag}"`} showHeader={false} fullWidth={true}>
    <div class="max-w-[1280px] mx-auto">
        <Breadcrumbs />

        <h1 class="mb-12 text-3xl leading-tight font-serif font-[800] sm:mb-16 sm:text-5xl" style="color: var(--text-heading)">Сервисы</h1>

        <!-- Блок тегов -->
        <TagsSection tags={tagsWithCount} activeTagId={slugify(tag)} basePath="/projects" totalCount={allProjects.length} class="mb-12" />

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mb-16">
            {projects.map((project) => <ProjectPreview project={project} />)}
        </div>

        <!-- Пагинация (показывается только если больше одной страницы) -->
        {page.lastPage > 1 && <Pagination page={page} class="my-16 sm:my-24" />}
    </div>
</BaseLayout>
