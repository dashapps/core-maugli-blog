---
import { ClientRouter } from 'astro:transitions';
import BaseHead, { type Props as HeadProps } from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import MaugliFloatingLabel from '../components/MaugliFloatingLabel.astro';
import Header from '../components/Header.astro';
import Nav from '../components/Nav.astro';
import { maugliConfig } from '../config/maugli.config';

export type Props = HeadProps & { showHeader?: boolean; fullWidth?: boolean };

const { showHeader = true, fullWidth = false, ...head } = Astro.props;
---

<!doctype html>
<html lang="ru" class="antialiased break-words bg-main">
    <head>
        <BaseHead {...head} />
        <script define:vars={{ defaultTheme: maugliConfig.defaultTheme || 'auto' }}>
            // Инициализация темы до загрузки DOM
            function initTheme() {
                const savedTheme = localStorage.getItem('theme');
                let appliedTheme;

                if (savedTheme) {
                    // Если есть сохранённая тема, используем её
                    appliedTheme = savedTheme;
                } else {
                    // Если нет сохранённой темы, используем значение из конфигурации
                    if (defaultTheme === 'auto') {
                        // Автоматический выбор на основе системных настроек
                        appliedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    } else {
                        // Используем тему из конфигурации
                        appliedTheme = defaultTheme;
                    }
                }

                if (appliedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }

            initTheme();

            // Сохранение темы при переходах между страницами
            document.addEventListener('astro:page-load', () => {
                // Переинициализируем тему на каждой новой странице
                const savedTheme = localStorage.getItem('theme');
                let appliedTheme;

                if (savedTheme) {
                    appliedTheme = savedTheme;
                } else {
                    // Если нет сохранённой темы, используем значение из конфигурации
                    if (defaultTheme === 'auto') {
                        appliedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    } else {
                        appliedTheme = defaultTheme;
                    }
                }

                if (appliedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        </script>
        <ClientRouter />
    </head>
    <body class="bg-main text-main">
        <div class="flex flex-col min-h-screen px-4 md:px-8 w-full">
            <Nav />
            {showHeader && <Header />}
            <main class:list={['grow w-full mx-auto', fullWidth ? 'max-w-none' : 'max-w-3xl', 'pt-24']}>
                <slot />
            </main>
            <Footer />
            <MaugliFloatingLabel />
        </div>
    </body>
</html>
